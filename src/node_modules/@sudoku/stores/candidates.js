import { writable } from 'svelte/store';

function createCandidates() {
	const candidates = writable({});

	return {
		subscribe: candidates.subscribe,

		replace(newCandidates) {
			const cloned = {};
			Object.entries(newCandidates || {}).forEach(([key, values]) => {
				cloned[key] = [...values];
			});
			candidates.set(cloned);
		},

		reset() {
			candidates.set({});
		},

		add(pos, candidate) {
			candidates.update($candidates => {
				if (!$candidates.hasOwnProperty(pos.x + ',' + pos.y)) {
					$candidates[pos.x + ',' + pos.y] = [candidate];
				} else if ($candidates[pos.x + ',' + pos.y].includes(candidate)) {
					delete $candidates[pos.x + ',' + pos.y][$candidates[pos.x + ',' + pos.y].indexOf(candidate)];
				} else {
					$candidates[pos.x + ',' + pos.y].push(candidate);
				}

				return $candidates;
			});
		},

		clear(pos) {
			candidates.update($candidates => {
				delete $candidates[pos.x + ',' + pos.y];
				return $candidates;
			});
		},

		remove(pos, valuesToRemove) {
			candidates.update($candidates => {
				const key = pos.x + ',' + pos.y;
				if ($candidates[key]) {
					const newCandidates = $candidates[key].filter(c => !valuesToRemove.includes(c));
					if (newCandidates.length === 0) {
						delete $candidates[key];
					} else {
						$candidates[key] = newCandidates;
					}
				}
				return $candidates;
			});
		}
	}
}

export const candidates = createCandidates();