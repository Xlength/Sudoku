import { derived } from 'svelte/store';
import { IGridValidator } from '../interfaces/grid-validator.js';
import { StandardSudokuValidator } from '../validators/standard-sudoku-validator.js';

/**
 * 网格验证器管理器 - 负责验证逻辑的管理
 * 
 * OOAD设计原则：
 * 1. 单一职责：只负责验证逻辑的管理
 * 2. 策略模式：可以替换不同的验证器
 * 3. 依赖倒置：依赖IGridValidator接口
 * 4. 开闭原则：可以添加新的验证规则而不修改现有代码
 */
function createGridValidator(userGridStore, validator = null) {
	// 如果没有提供验证器，使用默认实现
	if (!validator) {
		validator = new StandardSudokuValidator();
	}

	// 验证验证器接口
	if (!(validator instanceof IGridValidator)) {
		throw new Error('Validator must implement IGridValidator interface');
	}

	/**
	 * 创建无效单元格的派生store
	 * 使用策略模式，可以替换验证器
	 */
	const invalidCells = derived(userGridStore, $userGrid => {
		const conflicts = validator.findConflicts($userGrid);
		// 转换为字符串格式的坐标列表（保持向后兼容）
		return conflicts.map(pos => `${pos.x},${pos.y}`);
	}, []);

	return {
		subscribe: invalidCells.subscribe,
		validator, // 暴露验证器，允许替换
	};
}

// 导出工厂函数
export { createGridValidator };