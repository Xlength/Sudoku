import { candidates } from '../stores/candidates.js';
import { userGrid } from '../stores/grid.js';
import { cursor } from '../stores/cursor.js';
import { get } from 'svelte/store';

/**
 * 结果应用器 - 负责将策略处理结果应用到游戏状态
 * 
 * OOAD设计原则：
 * 1. 单一职责：专门负责应用操作结果
 * 2. 开闭原则：可以扩展新的结果类型而不修改现有代码
 * 3. 依赖倒置：依赖抽象（结果对象），不依赖具体实现
 */
class ResultApplier {
	/**
	 * 应用Next Step结果
	 * @param {Object} result - Next Step处理结果
	 */
	applyNextStepResult(result) {
		if (result.type === 'solve' && result.solved) {
			// 确定数字
			result.solved.forEach(solve => {
				const key = `${solve.position.x},${solve.position.y}`;
				if (get(candidates)[key]) {
					candidates.clear(solve.position);
				}
				userGrid.set(solve.position, solve.value);
			});
		} else if (result.type === 'eliminate' && result.eliminations) {
			// 删除候选数
			result.eliminations.forEach(elim => {
				candidates.remove(elim.position, elim.removed);
			});
		}
	}

	/**
	 * 应用Hint结果
	 * @param {Object} suggestion - 提示结果
	 * @param {Object} originalCandidates - 用户原有的候选数
	 */
	applyHintResult(suggestion, originalCandidates) {
		// 恢复到用户原有的候选数状态（自动清除我们补齐的候选数）
		candidates.replace(originalCandidates);
		
		// 填入确定的数字
		const key = `${suggestion.position.x},${suggestion.position.y}`;
		if (get(candidates)[key]) {
			candidates.clear(suggestion.position);
		}
		userGrid.set(suggestion.position, suggestion.value);
		cursor.set(suggestion.position.x, suggestion.position.y);
	}
}

export const resultApplier = new ResultApplier();
