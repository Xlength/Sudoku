import { cursor } from './stores/cursor';
import { difficulty } from './stores/difficulty';
import { gamePaused } from './stores/game';
import { grid } from './stores/grid';
import { timer } from './stores/timer';
import { hints } from './stores/hints';
import { gameMode } from './stores/game-mode';
import { candidates } from './stores/candidates';
import { history } from './services/history-manager';
import { candidateManager } from './services/candidate-manager';

/**
 * 游戏控制器 - 负责游戏流程的统一管理
 * 
 * OOAD设计原则：
 * 1. 单一职责：专门负责游戏流程控制
 * 2. 封装：将相关功能封装在一个类中
 * 3. 依赖注入：通过构造函数注入依赖，便于测试和扩展
 * 4. 开闭原则：可以扩展新的游戏控制功能而不修改现有代码
 */
class GameController {
	constructor(
		difficultyStore = difficulty,
		gridStore = grid,
		cursorStore = cursor,
		timerStore = timer,
		hintsStore = hints,
		candidatesStore = candidates,
		historyService = history,
		gamePausedStore = gamePaused
	) {
		this.difficulty = difficultyStore;
		this.grid = gridStore;
		this.cursor = cursorStore;
		this.timer = timerStore;
		this.hints = hintsStore;
		this.candidates = candidatesStore;
		this.history = historyService;
		this.gamePaused = gamePausedStore;
	}

	/**
	 * 开始新游戏（生成数独）
	 *
	 * @param {('veryeasy' | 'easy' | 'medium' | 'hard')} diff - 难度
	 */
	startNew(diff) {
		this.difficulty.set(diff);
		this.grid.generate(diff);
		this.resetGameState();
		location.hash = '';
	}

	/**
	 * 开始自定义游戏（从编码字符串）
	 *
	 * @param {string} sencode - 数独编码字符串
	 */
	startCustom(sencode) {
		this.difficulty.setCustom();
		this.grid.decodeSencode(sencode);
		this.resetGameState();
	}

	/**
	 * 重置游戏状态
	 * 封装重置逻辑，避免代码重复
	 */
	resetGameState() {
		this.cursor.reset();
		this.timer.reset();
		this.hints.reset();
		this.candidates.reset();
		this.history.reset();
	}

	/**
	 * 暂停游戏
	 */
	pause() {
		this.timer.stop();
		this.gamePaused.set(true);
	}

	/**
	 * 恢复游戏
	 */
	resume() {
		this.timer.start();
		this.gamePaused.set(false);
	}
}

/**
 * 创建单例实例（保持向后兼容）
 */
const gameController = new GameController();

/**
 * 导出函数接口（保持向后兼容）
 */
export function startNew(diff) {
	gameController.startNew(diff);
}

export function startCustom(sencode) {
	gameController.startCustom(sencode);
}

export function pauseGame() {
	gameController.pause();
}

export function resumeGame() {
	gameController.resume();
}

/**
 * 导出默认对象（保持向后兼容）
 */
export default {
	startNew,
	startCustom,
	pause: pauseGame,
	resume: resumeGame
};

/**
 * 导出类（供需要扩展的场景使用）
 */
export { GameController };